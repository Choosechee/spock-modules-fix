<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Peter Niederwieser, Leonard Brünings, The Spock Framework Team">
<title>Utilities</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
</head>
<body id="utilities" class="article">
<div id="header">
<h1>Utilities</h1>
<div class="details">
<span id="author" class="author">Peter Niederwieser, Leonard Brünings, The Spock Framework Team</span><br>
<span id="revnumber">version 2.1-SNAPSHOT</span>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="mutable-clock"><a class="anchor" href="#mutable-clock"></a><a class="link" href="#mutable-clock">Testing Time with <code>MutableClock</code></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>When working with dates or time we often have the problem of writing stable tests.
Java only provides a <code>FixedClock</code> for testing.
However, often time related code has to deal with the change of time,
so a fixed clock is not enough or makes the test harder to follow.</p>
</div>
<div class="paragraph">
<p>The prerequisite for using both <code>FixedClock</code> and Spocks <code>MutableClock</code> is that the production code,
actually uses a configurable <code>Clock</code> and not just the parameterless <code>Instant.now()</code>
or the corresponding methods in the other <code>java.time.*</code> classes.</p>
</div>
<div class="sect2">
<h3 id="_example"><a class="anchor" href="#_example"></a><a class="link" href="#_example">Example</a></h3>
<div class="listingblock">
<div class="title">Class under Test</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">public</span> <span class="type">class</span> <span class="class">AgeFilter</span> <span class="directive">implements</span> <span class="predefined-type">Predicate</span>&lt;LocalDate&gt; {
  <span class="directive">private</span> <span class="directive">final</span> Clock clock;
  <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> age;

  <span class="directive">public</span> AgeFilter(Clock clock, <span class="type">int</span> age) {                                       // <b class="conum">(1)</b>
    <span class="local-variable">this</span>.clock = clock;
    <span class="local-variable">this</span>.age = age;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">boolean</span> test(LocalDate date) {
    <span class="keyword">return</span> Period.between(date, LocalDate.now(clock)).getYears() &gt;= age;         // <b class="conum">(2)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>Clock</code> is injected via constructor</p>
</li>
<li>
<p><code>Clock</code> is used to get the current date</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Test</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">  <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">AgeFilter reacts to time</span><span class="delimiter">&quot;</span></span>() {
    <span class="key">given</span>:
    ZonedDateTime defaultTime = ZonedDateTime.of(<span class="integer">2018</span>, <span class="integer">6</span>, <span class="integer">5</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, ZoneId.of(<span class="string"><span class="delimiter">'</span><span class="content">UTC</span><span class="delimiter">'</span></span>))
    MutableClock clock = <span class="keyword">new</span> MutableClock(defaultTime)                                       // <b class="conum">(1)</b>
    AgeFilter ageFilter = <span class="keyword">new</span> AgeFilter(clock,<span class="integer">18</span>)                                            // <b class="conum">(2)</b>

    LocalDate birthday = defaultTime.minusYears(<span class="integer">18</span>).plusDays(<span class="integer">1</span>).toLocalDate()

    <span class="key">expect</span>:
    !ageFilter.test(birthday)                                                                // <b class="conum">(3)</b>

    <span class="key">when</span>:
    clock + <span class="predefined-type">Duration</span>.ofDays(<span class="integer">1</span>)                                                               // <b class="conum">(4)</b>

    <span class="key">then</span>:
    ageFilter.test(birthday)                                                                 // <b class="conum">(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>MutableClock</code> created with a well known time</p>
</li>
<li>
<p><code>Clock</code> is injected via constructor</p>
</li>
<li>
<p><code>age</code> is less than <code>18</code> so the result is <code>false</code></p>
</li>
<li>
<p>the clock is advanced by one day</p>
</li>
<li>
<p><code>age</code> is equal to <code>18</code> so the result is <code>true</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are many more ways to modify <code>MutableClock</code> just have a look at the JavaDocs, or the test code <code>spock.util.time.MutableClockSpec</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.1-SNAPSHOT<br>
Last updated 2021-10-24 15:40:07 UTC
</div>
</div>
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</body>
</html>